import tkinter as tk
from tkinter import filedialog, messagebox, ttk, simpledialog
from ttkthemes import ThemedTk
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import os
import datetime
from PIL import Image, ImageTk
from fpdf import FPDF
import random
import numpy as np
import threading
import requests
import json
import time
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage
from email.mime.application import MIMEApplication
import io

# ---------- YAPILANDIRMA ----------
APP_TITLE = "KumaÅŸ Reklamasyon & Kalite YÃ¶netim Sistemi v8.1"
THEME_NAME = "arc"
EXCEL_FILE_NAME = "kumas_verileri.xlsx"

# Gemini API AyarlarÄ±
GEMINI_API_KEY = "" 
GEMINI_MODEL = "gemini-2.0-flash-exp" 
API_URL = f"https://generativelanguage.googleapis.com/v1beta/models/{GEMINI_MODEL}:generateContent"

# Mail AyarlarÄ± (VarsayÄ±lan)
SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
SENDER_EMAIL = "ozan.sabudak@defacto.com"
SENDER_PASSWORD = "dzeknqmdooemcwlk"
GMAIL_RECEIVER_LOGS = "ozan.sabudak@defacto.com"

# Global DeÄŸiÅŸkenler
df_global = None
current_page_name = None
frames = {}
menu_buttons = {}
defect_images = []

# --- YardÄ±mcÄ± Export FonksiyonlarÄ± ---
def tr_to_eng(text):
    if not isinstance(text, str): return str(text)
    tr_map = str.maketrans("ÄŸÄžÄ±Ä°Ã¶Ã–Ã¼ÃœÅŸÅžÃ§Ã‡", "gGiIoOuUsScC")
    return text.translate(tr_map)

def export_df_to_excel(df, default_name="Export", auto_save=False):
    if df is None or df.empty: return None
    if auto_save:
        filename = f"{default_name}_{datetime.date.today()}.xlsx"
        df.to_excel(filename, index=False)
        return filename
    f = filedialog.asksaveasfilename(initialfile=f"{default_name}_{datetime.date.today()}", defaultextension=".xlsx", filetypes=[("Excel Files", "*.xlsx")])
    if f:
        try: df.to_excel(f, index=False); messagebox.showinfo("BaÅŸarÄ±lÄ±", "Excel dosyasÄ± oluÅŸturuldu.")
        except Exception as e: messagebox.showerror("Hata", str(e))
    return None

def export_df_to_pdf(df, title, default_name="Export", auto_save=False):
    if df is None or df.empty: return None
    
    def create_pdf(filename):
        pdf = FPDF(orientation='L', unit='mm', format='A4')
        pdf.add_page()
        pdf.set_font("Arial", 'B', 14)
        pdf.cell(0, 10, tr_to_eng(title), ln=True, align='C')
        pdf.ln(5)
        pdf.set_font("Arial", 'B', 8)
        cols = df.columns
        col_w = 275 / len(cols)
        for col in cols: pdf.cell(col_w, 8, tr_to_eng(str(col))[:15], 1)
        pdf.ln()
        pdf.set_font("Arial", '', 7)
        for _, row in df.iterrows():
            for col in cols:
                val = str(row[col])
                pdf.cell(col_w, 6, tr_to_eng(val)[:20], 1)
            pdf.ln()
        pdf.output(filename)
        return filename

    if auto_save:
        filename = f"{default_name}_{datetime.date.today()}.pdf"
        try: return create_pdf(filename)
        except: return None
    
    f = filedialog.asksaveasfilename(initialfile=f"{default_name}_{datetime.date.today()}", defaultextension=".pdf", filetypes=[("PDF Files", "*.pdf")])
    if f:
        try: create_pdf(f); messagebox.showinfo("BaÅŸarÄ±lÄ±", "PDF dosyasÄ± oluÅŸturuldu.")
        except Exception as e: messagebox.showerror("Hata", str(e))
    return None

# YardÄ±mcÄ± Fonksiyon: Para ve SayÄ± FormatÄ± Temizleme
def clean_currency(val):
    if pd.isna(val) or str(val).strip() in ['-', '', 'nan', 'NaT']: return 0.0
    if isinstance(val, (int, float)): return float(val)
    val = str(val).replace('â‚º', '').replace(' ', '')
    if '.' in val and ',' in val: val = val.replace('.', '').replace(',', '.')
    elif ',' in val: val = val.replace(',', '.')
    try: return float(val)
    except: return 0.0

# Ã–rnek Veri OluÅŸturma
def create_dummy_data():
    data = {
        "FiÅŸ Tipi": ["62 - Mamul KumaÅŸ AlÄ±m Ä°rsaliyesi", "62 - Mamul KumaÅŸ AlÄ±m Ä°rsaliyesi", "63 - Mamul KumaÅŸ AlÄ±m Ä°ade", "63 - Mamul KumaÅŸ AlÄ±m Ä°ade", "52 - Verilen Reklamasyon FiÅŸi", "62 - Mamul KumaÅŸ AlÄ±m Ä°rsaliyesi"],
        "FiÅŸ Tarihi": ["06.01.2026", "10.01.2026", "13.01.2026", "07.01.2026", "15.01.2026", "01.01.2026"],
        "Cari AdÄ±": ["UNÄ°TY TEKSTÄ°L", "UNÄ°TY TEKSTÄ°L", "BÄ°RCAN KUMAÅž", "REHA BOYA", "Ã–ZYURT TEKSTÄ°L", "TARTEKS Ä°PLÄ°K"],
        "Order No": ["G8773A8-1805799", "G8773A8-1805799", "F8160AX", "F8666AX", "G5901A5", "E8430A5"],
        "MÃ¼ÅŸteri Termin Tarihi": ["01.04.2026", "01.04.2026", "10.01.2026", "05.01.2026", "20.01.2026", "05.01.2026"],
        "SipariÅŸ Termin Tarihi": ["17.01.2026", "08.01.2026", "10.01.2026", "05.01.2026", "10.01.2026", "05.01.2026"],
        "Stok Kodu": ["05 BRIBDUZ", "05 BSUPDUZ", "05 BSUPBSK", "05 BRIB", "05 BKKDUZ", "05 B2IP"],
        "Stok AdÄ±": ["RÄ°BANA 1X1", "SÃœPREM DÃœZ", "SÃœPREM BASKILI", "RÄ°BANA", "KAÅžKORSE", "2 Ä°PLÄ°K"],
        "Var - 1": ["ER105-ECRU", "ER105-ECRU", "BLUE", "ANTHRA", "GREEN", "RED"],
        "Parti/Lab No": ["12223-3", "12223-1", "1506", "7215", "2907", "2500"],
        "SipariÅŸ FiÅŸi FiÅŸ No": ["5", "6", "10", "11", "12", "13"],
        "Tahsis Net Mik.": ["64,00", "365,00", "24,00", "50,00", "1,00", "100,00"],
        "Tahsis TutarÄ±": ["16.640,00", "91.250,00", "6.996,00", "13.250,00", "33.000,00", "15.000,00"],
        "AÃ§Ä±klama": ["", "", "Leke HatasÄ±", "Termin Gecikmesi", "Fiyat FarkÄ±", ""],
        "Stok FiÅŸi Detay Reklamasyon Sebepleri": ["", "", "Kalite Kontrol Red", "Termin Gecikmesi", "Kalite OnaylanmadÄ±", ""],
        "Order Grup AdÄ±": ["YÄ° Ã–RME-5 (ERKEK Ã‡OCUK/BEBEK)", "YÄ° Ã–RME-5 (ERKEK Ã‡OCUK/BEBEK)", "YÄ° Ã–RME-2 (YOUNG)", "YÄ° Ã–RME-2 (YOUNG)", "YÄ° Ã–RME-5 (ERKEK Ã‡OCUK/BEBEK)", "YÄ° Ã–RME-1 (SMART CORE)"]
    }
    df = pd.DataFrame(data)
    df["Tahsis TutarÄ±_Clean"] = df["Tahsis TutarÄ±"].apply(clean_currency)
    df["Tahsis Net Mik._Clean"] = df["Tahsis Net Mik."].apply(clean_currency)
    return df

# Veri YÃ¼kleme
def load_data(filepath=None):
    global df_global
    try:
        if filepath: df = pd.read_excel(filepath)
        elif os.path.exists(EXCEL_FILE_NAME): df = pd.read_excel(EXCEL_FILE_NAME)
        else: df = create_dummy_data()
        
        df.rename(columns={"SipariÅŸ FiÅŸi Termin Tarihi": "SipariÅŸ Termin Tarihi", "Order MÃ¼ÅŸteri Termin Tarihi": "MÃ¼ÅŸteri Termin Tarihi"}, inplace=True)
        if "Tahsis TutarÄ±" in df.columns: df["Tahsis TutarÄ±_Clean"] = df["Tahsis TutarÄ±"].apply(clean_currency)
        else: df["Tahsis TutarÄ±_Clean"] = 0.0
        qty_col = "Tahsis Net Mik." if "Tahsis Net Mik." in df.columns else "Net Mik."
        if qty_col in df.columns: df["Miktar_Clean"] = df[qty_col].apply(clean_currency)
        else: df["Miktar_Clean"] = 0.0

        for col in ["FiÅŸ Tarihi", "MÃ¼ÅŸteri Termin Tarihi", "SipariÅŸ Termin Tarihi"]:
            if col in df.columns: df[col] = pd.to_datetime(df[col], dayfirst=True, errors='coerce')
            else: df[col] = pd.NaT

        df["Musteri_Gecikme"] = (df["FiÅŸ Tarihi"] - df["MÃ¼ÅŸteri Termin Tarihi"]).dt.days
        df["Siparis_Gecikme"] = (df["FiÅŸ Tarihi"] - df["SipariÅŸ Termin Tarihi"]).dt.days

        def determine_type(row):
            ft = str(row.get('FiÅŸ Tipi', '')).lower()
            if '52' in ft or 'reklamasyon' in ft: return 'Reklamasyon'
            if '63' in ft or 'iade' in ft: return 'Ä°ade'
            if '62' in ft or 'alÄ±m' in ft: return 'AlÄ±m'
            return 'DiÄŸer'
        df['Islem_Tipi'] = df.apply(determine_type, axis=1)

        def calculate_metrics(row):
            tip = row['Islem_Tipi']; gecikme = row['Siparis_Gecikme'] if pd.notna(row['Siparis_Gecikme']) else 0
            miktar = row['Miktar_Clean']; tutar = row['Tahsis TutarÄ±_Clean']
            on_time_qty = 0; late_qty = 0; return_qty = 0; reklamasyon_tutar = 0; iade_tutar = 0; alim_tutar = 0; alim_qty = 0; rek_qty = 0
            if tip == 'AlÄ±m':
                alim_tutar = tutar; alim_qty = miktar
                if gecikme <= 0: on_time_qty = miktar
                else: late_qty = miktar
            elif tip == 'Ä°ade': iade_tutar = tutar; return_qty = miktar
            elif tip == 'Reklamasyon': reklamasyon_tutar = tutar; rek_qty = miktar
            return pd.Series([on_time_qty, late_qty, return_qty, reklamasyon_tutar, iade_tutar, alim_tutar, alim_qty, rek_qty])

        df[['On_Time_Miktar', 'Geciken_Miktar', 'Iade_Edilen_Miktar', 'Reklamasyon_Tutari', 'Iade_Tutari', 'Alim_Tutari', 'Alim_Miktar', 'Reklamasyon_Miktar']] = df.apply(calculate_metrics, axis=1)

        def get_reklamasyon_sebebi_tutar(row):
            if row['Islem_Tipi'] not in ['Ä°ade', 'Reklamasyon']: return 0, 0
            aciklama = str(row.get("AÃ§Ä±klama", "")).lower(); detay_sebep = str(row.get("Stok FiÅŸi Detay Reklamasyon Sebepleri", "")).lower()
            tutar = row['Tahsis TutarÄ±_Clean']
            if "gecikme" in aciklama or "termin" in aciklama or "gecikme" in detay_sebep: return tutar, 0
            elif "kalite" in detay_sebep: return 0, tutar
            else: return 0, 0 

        df[['Kesinti_Gecikme', 'Kesinti_Kalite']] = df.apply(lambda r: pd.Series(get_reklamasyon_sebebi_tutar(r)), axis=1)
        if "Order Grup AdÄ±" in df.columns: df["Order Grup AdÄ±"] = df["Order Grup AdÄ±"].fillna("DiÄŸer")
        else: df["Order Grup AdÄ±"] = "DiÄŸer"
        df_global = df
        return True, f"Veri yÃ¼klendi: {len(df)} satÄ±r."
    except Exception as e:
        df_global = create_dummy_data()
        return False, str(e)

load_data()

# ---------- MAIL MODÃœLÃœ ----------
def init_mail_tab():
    for widget in frame_mail.winfo_children(): widget.destroy()

    # BaÅŸlÄ±k
    header = tk.Frame(frame_mail, bg="#2c3e50", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ðŸ“§ Profesyonel Rapor PaylaÅŸÄ±m Merkezi", font=("Segoe UI", 18, "bold"), fg="white", bg="#2c3e50").pack(side="left")

    # Ä°Ã§erik
    content = tk.Frame(frame_mail, bg="#ecf0f1", padx=20, pady=20)
    content.pack(fill="both", expand=True)

    # Ayarlar Frame
    settings_frame = tk.LabelFrame(content, text="GÃ¶nderim AyarlarÄ±", bg="white", font=("Segoe UI", 10, "bold"), padx=15, pady=15)
    settings_frame.pack(fill="x", pady=10)

    tk.Label(settings_frame, text="AlÄ±cÄ± Email:", bg="white").grid(row=0, column=0, sticky="w", pady=5)
    entry_to = ttk.Entry(settings_frame, width=40); entry_to.grid(row=0, column=1, pady=5, padx=10)
    if GMAIL_RECEIVER_LOGS: entry_to.insert(0, GMAIL_RECEIVER_LOGS)

    tk.Label(settings_frame, text="Konu:", bg="white").grid(row=1, column=0, sticky="w", pady=5)
    entry_subject = ttk.Entry(settings_frame, width=40); entry_subject.grid(row=1, column=1, pady=5, padx=10)
    entry_subject.insert(0, f"HaftalÄ±k Kalite & Reklamasyon Raporu - {datetime.date.today()}")

    # Kimlik Bilgileri
    tk.Label(settings_frame, text="GÃ¶nderen Email:", bg="white").grid(row=0, column=2, sticky="w", pady=5, padx=(20,0))
    entry_user = ttk.Entry(settings_frame, width=30); entry_user.grid(row=0, column=3, pady=5, padx=10)
    if SENDER_EMAIL: entry_user.insert(0, SENDER_EMAIL)
    
    tk.Label(settings_frame, text="Uygulama Åžifresi:", bg="white").grid(row=1, column=2, sticky="w", pady=5, padx=(20,0))
    entry_pass = ttk.Entry(settings_frame, width=30, show="*"); entry_pass.grid(row=1, column=3, pady=5, padx=10)
    if SENDER_PASSWORD: entry_pass.insert(0, SENDER_PASSWORD)

    # GÃ¶nderim Fonksiyonu
    def send_rich_email():
        to_addr = entry_to.get()
        user_email = entry_user.get()
        user_pass = entry_pass.get()
        
        if not to_addr or not user_email or not user_pass:
            messagebox.showwarning("Eksik Bilgi", "LÃ¼tfen tÃ¼m alanlarÄ± doldurun.")
            return

        try:
            status_lbl.config(text="Raporlar hazÄ±rlanÄ±yor ve grafikler oluÅŸturuluyor...", fg="blue")
            root.update()

            # 1. GrafiÄŸi OluÅŸtur ve Kaydet
            fig = plt.figure(figsize=(8, 4), dpi=100)
            ax = fig.add_subplot(111)
            if df_global is not None:
                risk_data = df_global.groupby("Order Grup AdÄ±")[["Iade_Tutari", "Reklamasyon_Tutari"]].sum().sum(axis=1).sort_values(ascending=False).head(5)
                risk_data.plot(kind="barh", ax=ax, color="#e74c3c")
                ax.set_title("En YÃ¼ksek Riskli TakÄ±mlar")
            plt.tight_layout()
            chart_path = "temp_chart.png"
            fig.savefig(chart_path)
            plt.close(fig)

            # 2. Excel ve PDF RaporlarÄ± OluÅŸtur
            excel_path = export_df_to_excel(df_global, "Rapor", auto_save=True)
            pdf_path = export_df_to_pdf(df_global.head(50), "Ozet Rapor", "Ozet", auto_save=True)

            # 3. HTML Ä°Ã§erik HazÄ±rla
            total_risk = df_global["Iade_Tutari"].sum() + df_global["Reklamasyon_Tutari"].sum()
            total_buy = df_global["Alim_Tutari"].sum()
            
            html_content = f"""
            <html>
                <body style="font-family: Arial, sans-serif; color: #333;">
                    <div style="background-color: #2c3e50; padding: 20px; color: white; text-align: center; border-radius: 5px 5px 0 0;">
                        <h1>KumaÅŸ Kalite Raporu</h1>
                        <p>{datetime.date.today()}</p>
                    </div>
                    <div style="padding: 20px; border: 1px solid #ddd; border-top: none;">
                        <h2 style="color: #2c3e50;">ðŸ“Š YÃ¶netici Ã–zeti</h2>
                        <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                            <div style="background-color: #27ae60; color: white; padding: 15px; border-radius: 5px; width: 45%; text-align: center;">
                                <h3>Toplam AlÄ±m</h3>
                                <p style="font-size: 24px; margin: 0;">{total_buy:,.0f} â‚º</p>
                            </div>
                            <div style="background-color: #c0392b; color: white; padding: 15px; border-radius: 5px; width: 45%; text-align: center;">
                                <h3>Toplam Risk</h3>
                                <p style="font-size: 24px; margin: 0;">{total_risk:,.0f} â‚º</p>
                            </div>
                        </div>
                        <h3>ðŸ“‰ Risk Analizi GrafiÄŸi</h3>
                        <img src="cid:dashboard_chart" alt="Grafik" style="width: 100%; max-width: 600px; border: 1px solid #eee; border-radius: 5px;">
                        <p style="margin-top: 20px;">DetaylÄ± raporlar ekte sunulmuÅŸtur.</p>
                        <hr>
                        <p style="font-size: 12px; color: gray;">Bu mail KumaÅŸ Reklamasyon Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.</p>
                    </div>
                </body>
            </html>
            """

            # 4. Maili OluÅŸtur
            msg = MIMEMultipart('related')
            msg['Subject'] = entry_subject.get()
            msg['From'] = user_email
            msg['To'] = to_addr

            msg_alternative = MIMEMultipart('alternative')
            msg.attach(msg_alternative)
            msg_alternative.attach(MIMEText(html_content, 'html'))

            # Resmi Ekle
            with open(chart_path, 'rb') as f:
                img_data = f.read()
            image = MIMEImage(img_data)
            image.add_header('Content-ID', '<dashboard_chart>')
            msg.attach(image)

            # DosyalarÄ± Ekle
            for f_path in [excel_path, pdf_path]:
                if f_path and os.path.exists(f_path):
                    with open(f_path, "rb") as f:
                        part = MIMEApplication(f.read(), Name=os.path.basename(f_path))
                    part['Content-Disposition'] = f'attachment; filename="{os.path.basename(f_path)}"'
                    msg.attach(part)

            # 5. GÃ¶nder
            server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
            server.starttls()
            server.login(user_email, user_pass)
            server.send_message(msg)
            server.quit()

            # Temizlik
            if os.path.exists(chart_path): os.remove(chart_path)
            if excel_path and os.path.exists(excel_path): os.remove(excel_path)
            if pdf_path and os.path.exists(pdf_path): os.remove(pdf_path)

            status_lbl.config(text="âœ… Mail baÅŸarÄ±yla gÃ¶nderildi!", fg="green")
            messagebox.showinfo("BaÅŸarÄ±lÄ±", "Rapor maili gÃ¶nderildi.")

        except Exception as e:
            status_lbl.config(text="Hata oluÅŸtu.", fg="red")
            messagebox.showerror("GÃ¶nderim HatasÄ±", f"Mail gÃ¶nderilemedi:\n{str(e)}")

    btn_send = tk.Button(content, text="ðŸš€ Raporu GÃ¶nder", bg="#2980b9", fg="white", font=("Segoe UI", 12, "bold"), padx=20, pady=10, command=send_rich_email)
    btn_send.pack(pady=20)
    
    status_lbl = tk.Label(content, text="", bg="#ecf0f1", font=("Segoe UI", 10))
    status_lbl.pack()

# ---------- YZ MODÃœLÃœ ----------
def auto_generate_ai_comment(parent_frame, context="Genel"):
    ai_container = tk.Frame(parent_frame, bg="#f0f8ff", bd=1, relief="solid")
    ai_container.pack(side="bottom", fill="x", padx=20, pady=10)
    header = tk.Frame(ai_container, bg="#e1f5fe"); header.pack(fill="x")
    tk.Label(header, text="âœ¨ Yapay Zeka AsistanÄ±", font=("Segoe UI", 10, "bold"), fg="#0277bd", bg="#e1f5fe", padx=10, pady=5).pack(side="left")
    lbl_content = tk.Label(ai_container, text="Veriler analiz ediliyor...", font=("Segoe UI", 9), bg="#f0f8ff", fg="#37474f", justify="left", wraplength=1100, padx=10, pady=10)
    lbl_content.pack(fill="x")

    def _run_analysis():
        time.sleep(0.5) 
        if df_global is None or df_global.empty: lbl_content.config(text="Veri bulunamadÄ±."); return
        total_risk = df_global["Iade_Tutari"].sum() + df_global["Reklamasyon_Tutari"].sum()
        try: top_risk_team = df_global.groupby("Order Grup AdÄ±")[["Iade_Tutari", "Reklamasyon_Tutari"]].sum().sum(axis=1).idxmax()
        except: top_risk_team = "Bilinmiyor"
        fallback_msg = f"ANALÄ°Z SONUCU: Toplam {total_risk:,.0f} TL'lik kesinti riski tespit edilmiÅŸtir. En yÃ¼ksek risk '{top_risk_team}' grubunda gÃ¶rÃ¼lmektedir."
        if GEMINI_API_KEY:
            try:
                prompt = f"Tekstil Kalite UzmanÄ± olarak 1 cÃ¼mlelik Ã¶zet yap. Toplam Risk {total_risk} TL. En riskli takÄ±m: {top_risk_team}."
                url = f"{API_URL}?key={GEMINI_API_KEY}"
                resp = requests.post(url, headers={'Content-Type': 'application/json'}, json={"contents": [{"parts": [{"text": prompt}]}]}, timeout=5)
                if resp.status_code == 200: lbl_content.config(text=resp.json()['candidates'][0]['content']['parts'][0]['text'].strip())
                else: lbl_content.config(text=fallback_msg)
            except: lbl_content.config(text=fallback_msg)
        else: lbl_content.config(text=fallback_msg)
    threading.Thread(target=_run_analysis, daemon=True).start()

# ---------- DASHBOARD ----------
def draw_dashboard(parent):
    for widget in parent.winfo_children(): widget.destroy()
    top_bar = tk.Frame(parent, bg="white", padx=20, pady=15, bd=1, relief="raised"); top_bar.pack(fill="x")
    tk.Label(top_bar, text="ðŸ“Š YÃ–NETÄ°CÄ° DASHBOARD", font=("Segoe UI", 16, "bold"), fg="#2c3e50", bg="white").pack(side="left")
    
    # Butonlar
    btn_frame = tk.Frame(top_bar, bg="white"); btn_frame.pack(side="right", padx=10)
    tk.Button(btn_frame, text="ðŸ“§ Raporu Mail At", bg="#8e44ad", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: show_page("Mail Merkezi")).pack(side="left", padx=5)
    
    tk.Label(top_bar, text="TedarikÃ§i:", font=("Segoe UI", 10), bg="white", fg="gray").pack(side="right", padx=5)
    all_suppliers = sorted(df_global["Cari AdÄ±"].unique().astype(str)) if df_global is not None else []
    cari_var = tk.StringVar(value="TÃ¼mÃ¼"); cari_combo = ttk.Combobox(top_bar, values=["TÃ¼mÃ¼"] + list(all_suppliers), textvariable=cari_var, state="readonly", width=25)
    cari_combo.pack(side="right", padx=5)
    
    canvas = tk.Canvas(parent, bg="#ecf0f1"); scrollbar = ttk.Scrollbar(parent, orient="vertical", command=canvas.yview)
    scrollable_frame = tk.Frame(canvas, bg="#ecf0f1")
    scrollable_frame.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0, 0), window=scrollable_frame, anchor="nw"); canvas.configure(yscrollcommand=scrollbar.set)
    canvas.pack(side="left", fill="both", expand=True); scrollbar.pack(side="right", fill="y")

    current_dash_data = None
    def refresh_content(event=None):
        nonlocal current_dash_data
        for w in scrollable_frame.winfo_children(): w.destroy()
        sel_cari = cari_combo.get()
        df_d = df_global.copy() if sel_cari == "TÃ¼mÃ¼" else df_global[df_global["Cari AdÄ±"] == sel_cari]
        current_dash_data = df_d

        kpi_frame = tk.Frame(scrollable_frame, bg="#ecf0f1"); kpi_frame.pack(fill="x", pady=10, padx=10)
        t_alim_tut = df_d["Alim_Tutari"].sum(); t_iade_tut = df_d["Iade_Tutari"].sum(); t_rek_tut = df_d["Reklamasyon_Tutari"].sum()
        t_risk = t_iade_tut + t_rek_tut
        
        def draw_kpi(col, title, val1, val2, color):
            card = tk.Frame(kpi_frame, bg="white", bd=0, relief="flat", padx=15, pady=15)
            card.grid(row=0, column=col, sticky="ew", padx=10); kpi_frame.grid_columnconfigure(col, weight=1)
            tk.Frame(card, bg=color, width=5).pack(side="left", fill="y", padx=(0,10))
            tk.Label(card, text=title, font=("Segoe UI", 10, "bold"), fg="#95a5a6", bg="white").pack(anchor="w")
            tk.Label(card, text=val1, font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(anchor="w")
            if val2: tk.Label(card, text=val2, font=("Segoe UI", 9), fg=color, bg="white").pack(anchor="w")

        draw_kpi(0, "TOPLAM ALIM HACMÄ°", f"{t_alim_tut:,.0f} â‚º", f"{df_d['Alim_Miktar'].sum():,.0f} Birim", "#27ae60")
        draw_kpi(1, "TOPLAM RÄ°SK (Ä°ade+Rek.)", f"{t_risk:,.0f} â‚º", f"Ä°ade: {t_iade_tut:,.0f} | Rek: {t_rek_tut:,.0f}", "#c0392b")
        draw_kpi(2, "Ä°ADE TUTARI (Fatura)", f"{t_iade_tut:,.0f} â‚º", f"{df_d['Iade_Edilen_Miktar'].sum():,.0f} Birim", "#f39c12")
        draw_kpi(3, "KESÄ°LEN REKLAMASYON", f"{t_rek_tut:,.0f} â‚º", f"{df_d['Reklamasyon_Miktar'].sum():,.0f} Birim", "#8e44ad")

        chart_frame = tk.Frame(scrollable_frame, bg="#ecf0f1"); chart_frame.pack(fill="x", pady=10, padx=20)
        fig = plt.figure(figsize=(10, 4), dpi=100)
        ax1 = fig.add_subplot(121)
        if not df_d.empty:
            df_d.groupby("Cari AdÄ±")[["Iade_Tutari", "Reklamasyon_Tutari"]].sum().sum(axis=1).sort_values(ascending=False).head(5).plot(kind="bar", ax=ax1, color="#e74c3c", alpha=0.8)
        ax1.set_title("En YÃ¼ksek Riskli 5 TedarikÃ§i"); ax1.set_xlabel(""); plt.setp(ax1.xaxis.get_majorticklabels(), rotation=45, ha="right", fontsize=8)
        ax2 = fig.add_subplot(122); sizes = [t_iade_tut, t_rek_tut]
        if sum(sizes) > 0: ax2.pie(sizes, labels=['Ä°ade', 'Reklamasyon'], autopct='%1.1f%%', colors=['#f39c12', '#8e44ad'], startangle=90)
        else: ax2.text(0.5, 0.5, "Veri Yok", ha='center')
        ax2.set_title("Risk DaÄŸÄ±lÄ±mÄ±")
        plt.tight_layout(); canvas_fig = FigureCanvasTkAgg(fig, master=chart_frame); canvas_fig.draw(); canvas_fig.get_tk_widget().pack(fill="both", expand=True)
        auto_generate_ai_comment(scrollable_frame, "Dashboard")

    btn_ex = tk.Button(btn_frame, text="Excel Ä°ndir", bg="#27ae60", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: export_df_to_excel(current_dash_data, "Dashboard_Data"))
    btn_ex.pack(side="left", padx=5)
    btn_pdf = tk.Button(btn_frame, text="PDF Ä°ndir", bg="#c0392b", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: export_df_to_pdf(current_dash_data.head(50), "YÃ¶netici Dashboard Ã–zeti", "Dashboard_Report"))
    btn_pdf.pack(side="left", padx=5)

    cari_combo.bind("<<ComboboxSelected>>", refresh_content); refresh_content()

# ---------- DETAYLI RAPOR (FÄ°LTRELÄ° & HATA GÄ°DERÄ°LMÄ°Åž) ----------
def init_detailed_report_tab():
    for widget in frame_detayli.winfo_children(): widget.destroy()
    notebook = ttk.Notebook(frame_detayli); notebook.pack(fill="both", expand=True, padx=10, pady=5)
    tab_detay = tk.Frame(notebook, bg="white"); notebook.add(tab_detay, text=" ðŸ“‹ DetaylÄ± Operasyonel Liste ")
    tab_ozet = tk.Frame(notebook, bg="white"); notebook.add(tab_ozet, text=" ðŸ“Š YÃ¶netici Ã–zeti (TakÄ±m BazlÄ±) ")

    def setup_detail_tab():
        filter_frame = tk.Frame(tab_detay, bg="#f8f9fa", padx=10, pady=15, bd=1, relief="solid")
        filter_frame.pack(fill="x", padx=10, pady=5)
        
        tk.Label(filter_frame, text="HÄ±zlÄ± Filtre:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=(0,5))
        status_var = tk.StringVar(value="TÃ¼mÃ¼")
        cb_status = ttk.Combobox(filter_frame, textvariable=status_var, state="readonly", values=["TÃ¼mÃ¼", "Geciken SipariÅŸler", "ZamanÄ±nda Teslim", "Ä°ade Olanlar", "Reklamasyon Olanlar"])
        cb_status.pack(side="left", padx=5)

        tk.Label(filter_frame, text="|  DetaylÄ± Arama:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=15)
        search_col_var = tk.StringVar(value="TÃ¼mÃ¼")
        cols_map = {"TedarikÃ§i": "Cari AdÄ±", "Order No": "Order No", "TakÄ±m": "Order Grup AdÄ±", "Stok AdÄ±": "Stok AdÄ±", "Parti No": "Parti/Lab No"}
        cb_col = ttk.Combobox(filter_frame, textvariable=search_col_var, state="readonly", values=["TÃ¼mÃ¼"] + list(cols_map.keys()), width=15)
        cb_col.pack(side="left", padx=5)
        entry_search = ttk.Entry(filter_frame, width=30); entry_search.pack(side="left", padx=5)
        
        # Export Buttons
        btn_xls = tk.Button(filter_frame, text="Excel", bg="#27ae60", fg="white", font=("Segoe UI", 8), command=lambda: export_df_to_excel(current_data_detail, "Detayli_Liste"))
        btn_xls.pack(side="right", padx=5)
        btn_pdf = tk.Button(filter_frame, text="PDF", bg="#c0392b", fg="white", font=("Segoe UI", 8), command=lambda: export_df_to_pdf(current_data_detail, "DetaylÄ± Operasyonel Rapor", "Detayli_Rapor"))
        btn_pdf.pack(side="right", padx=5)
        
        # Mail Butonu
        btn_mail = tk.Button(filter_frame, text="âœ‰ï¸ Mail At", bg="#8e44ad", fg="white", font=("Segoe UI", 8), command=lambda: show_page("Mail Merkezi"))
        btn_mail.pack(side="right", padx=5)

        tree_frame = tk.Frame(tab_detay); tree_frame.pack(fill="both", expand=True, padx=10, pady=5)
        cols = ["TedarikÃ§i", "Order No", "TakÄ±m", "Parti No", "Stok AdÄ±", "FiÅŸ No", "FiÅŸ Tarihi", "MÃ¼ÅŸ. Gecikme", "Sip. Gecikme", "On Time Mik.", "Geciken Mik.", "Ä°ade Mik.", "Ä°ade Tutar", "Rek. Mik.", "Rek. Tutar", "Net Mik.", "Rek. OranÄ±", "Gec. OranÄ±", "Gereken Ceza"]
        tree = ttk.Treeview(tree_frame, columns=cols, show="headings", height=15)
        vsb = ttk.Scrollbar(tree_frame, orient="vertical", command=tree.yview); hsb = ttk.Scrollbar(tree_frame, orient="horizontal", command=tree.xview)
        tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
        tree.grid(column=0, row=0, sticky='nsew'); vsb.grid(column=1, row=0, sticky='ns'); hsb.grid(column=0, row=1, sticky='ew')
        tree_frame.grid_columnconfigure(0, weight=1); tree_frame.grid_rowconfigure(0, weight=1)

        for c in cols:
            tree.heading(c, text=c)
            if "Mik" in c or "Oran" in c or "Tutar" in c or "Gecikme" in c or "Ceza" in c: tree.column(c, anchor="e", width=85)
            else: tree.column(c, anchor="w", width=120)
        
        current_data_detail = pd.DataFrame()

        def apply_filters(event=None):
            nonlocal current_data_detail
            for i in tree.get_children(): tree.delete(i)
            if df_global is None: return

            df_proc = df_global.copy()
            num_cols = ["Alim_Miktar", "Alim_Tutari", "Iade_Edilen_Miktar", "Iade_Tutari", "Reklamasyon_Miktar", "Reklamasyon_Tutari", "Siparis_Gecikme", "Musteri_Gecikme", "On_Time_Miktar", "Geciken_Miktar"]
            for col in num_cols:
                if col in df_proc.columns: df_proc[col] = pd.to_numeric(df_proc[col], errors='coerce').fillna(0)

            if "FiÅŸ Tarihi" in df_proc.columns:
                df_proc["FiÅŸ_Tarihi_Str"] = df_proc["FiÅŸ Tarihi"].apply(lambda x: x.strftime('%d.%m.%Y') if pd.notna(x) else "")
            else: df_proc["FiÅŸ_Tarihi_Str"] = ""
            if "SipariÅŸ FiÅŸi FiÅŸ No" not in df_proc.columns: df_proc["SipariÅŸ FiÅŸi FiÅŸ No"] = ""

            obj_cols = df_proc.select_dtypes(include=['object']).columns
            df_proc[obj_cols] = df_proc[obj_cols].fillna("Bilinmiyor")
            
            grp = df_proc.groupby(["Cari AdÄ±", "Order No", "Order Grup AdÄ±", "Parti/Lab No", "Stok AdÄ±", "SipariÅŸ FiÅŸi FiÅŸ No", "FiÅŸ_Tarihi_Str"]).agg({
                "Musteri_Gecikme": "max", "Siparis_Gecikme": "max", "On_Time_Miktar": "sum", "Geciken_Miktar": "sum", "Iade_Edilen_Miktar": "sum", 
                "Alim_Miktar": "sum", "Reklamasyon_Miktar": "sum", "Alim_Tutari": "sum", "Iade_Tutari": "sum", "Reklamasyon_Tutari": "sum"
            }).reset_index()

            status = status_var.get()
            if status == "Geciken SipariÅŸler": grp = grp[grp["Siparis_Gecikme"] > 0]
            elif status == "ZamanÄ±nda Teslim": grp = grp[grp["Siparis_Gecikme"] <= 0]
            elif status == "Ä°ade Olanlar": grp = grp[(grp["Iade_Tutari"] > 0) | (grp["Iade_Edilen_Miktar"] > 0)]
            elif status == "Reklamasyon Olanlar": grp = grp[(grp["Reklamasyon_Tutari"] > 0) | (grp["Reklamasyon_Miktar"] > 0)]

            txt = entry_search.get().lower()
            if txt:
                s_col = search_col_var.get()
                if s_col == "TÃ¼mÃ¼":
                    mask = grp.apply(lambda x: txt in str(x["Cari AdÄ±"]).lower() or txt in str(x["Order No"]).lower() or txt in str(x["Order Grup AdÄ±"]).lower() or txt in str(x["Parti/Lab No"]).lower() or txt in str(x["Stok AdÄ±"]).lower(), axis=1)
                    grp = grp[mask]
                else:
                    target = cols_map.get(s_col, s_col)
                    if target in grp.columns: grp = grp[grp[target].astype(str).str.lower().str.contains(txt, na=False)]
            
            current_data_detail = grp 
            t_on = 0; t_late = 0; t_ret_mik = 0; t_ret_tut = 0; t_rek_mik = 0; t_rek_tut = 0; t_net = 0; t_ceza = 0

            for idx, row in grp.iterrows():
                net_mik = row["Alim_Miktar"] - row["Iade_Edilen_Miktar"]
                total_risk = row["Iade_Tutari"] + row["Reklamasyon_Tutari"]
                oran = (total_risk / row["Alim_Tutari"] * 100) if row["Alim_Tutari"] > 0 else 0
                s_gec = int(row["Siparis_Gecikme"]); m_gec = int(row["Musteri_Gecikme"])
                ceza_orani = 0.0
                if s_gec > 0:
                    if s_gec < 7: ceza_orani = 0.05
                    elif 7 <= s_gec <= 15: ceza_orani = 0.10
                    else: ceza_orani = 0.25
                matrah = row["Alim_Tutari"] - row["Iade_Tutari"]
                if matrah < 0: matrah = 0
                gecikme_cezasi_tutar = matrah * ceza_orani

                t_on += row['On_Time_Miktar']; t_late += row['Geciken_Miktar']; t_ret_mik += row['Iade_Edilen_Miktar']
                t_ret_tut += row['Iade_Tutari']; t_rek_mik += row['Reklamasyon_Miktar']; t_rek_tut += row['Reklamasyon_Tutari']
                t_net += net_mik; t_ceza += gecikme_cezasi_tutar

                vals = (row["Cari AdÄ±"], row["Order No"], row["Order Grup AdÄ±"], row["Parti/Lab No"], row["Stok AdÄ±"], row["SipariÅŸ FiÅŸi FiÅŸ No"], row["FiÅŸ_Tarihi_Str"], m_gec, s_gec,
                        f"{row['On_Time_Miktar']:,.0f}", f"{row['Geciken_Miktar']:,.0f}", f"{row['Iade_Edilen_Miktar']:,.0f}", f"{row['Iade_Tutari']:,.0f}",
                        f"{row['Reklamasyon_Miktar']:,.0f}", f"{row['Reklamasyon_Tutari']:,.0f}", f"{net_mik:,.0f}", f"%{oran:.2f}",
                        f"%{ceza_orani*100:.0f}", f"{gecikme_cezasi_tutar:,.0f} â‚º")
                tags = []
                if s_gec > 0: tags.append('late')
                if row['Iade_Tutari'] > 0: tags.append('return')
                if row['Reklamasyon_Tutari'] > 0: tags.append('reclaim')
                tree.insert("", "end", values=vals, tags=tuple(tags))
            
            total_vals = ("TOPLAM", "", "", "", "", "", "", "", "", f"{t_on:,.0f}", f"{t_late:,.0f}", f"{t_ret_mik:,.0f}", f"{t_ret_tut:,.0f}", f"{t_rek_mik:,.0f}", f"{t_rek_tut:,.0f}", f"{t_net:,.0f}", "", "", f"{t_ceza:,.0f} â‚º")
            tree.insert("", "end", values=total_vals, tags=('bold_row',))
            tree.tag_configure('late', foreground='#c0392b') 
            tree.tag_configure('return', background='#fff3e0') 
            tree.tag_configure('reclaim', background='#ffebee') 
            tree.tag_configure('bold_row', font=('Segoe UI', 9, 'bold'), background='#cfd8dc')

        cb_status.bind("<<ComboboxSelected>>", apply_filters)
        entry_search.bind("<KeyRelease>", apply_filters)
        apply_filters()
        auto_generate_ai_comment(tab_detay, "Detay")

    def setup_summary_tab():
        exp_frame = tk.Frame(tab_ozet, bg="white", pady=5); exp_frame.pack(fill="x", padx=10)
        current_summary1 = pd.DataFrame(); current_summary2 = pd.DataFrame()
        btn_xls = tk.Button(exp_frame, text="TÃ¼m Ã–zeti Excel'e Aktar", bg="#27ae60", fg="white", font=("Segoe UI", 9), command=lambda: export_df_to_excel(current_summary1 if not current_summary1.empty else current_summary2, "Yonetici_Ozeti")); btn_xls.pack(side="right", padx=5)
        btn_pdf = tk.Button(exp_frame, text="PDF Yap", bg="#c0392b", fg="white", font=("Segoe UI", 9), command=lambda: export_df_to_pdf(current_summary1, "YÃ¶netici Ã–zeti", "Yonetici_Raporu")); btn_pdf.pack(side="right", padx=5)

        df_rek = df_global[df_global["Islem_Tipi"].isin(["Ä°ade", "Reklamasyon"])].copy() if df_global is not None else pd.DataFrame()
        df_proc = df_global.copy() if df_global is not None else pd.DataFrame()
        
        # --- TÃœM VERÄ°YÄ° KAPSAYAN MERGE HAZIRLIÄžI ---
        # 1. Ceza Verisi (Gecikme olan tÃ¼m satÄ±rlardan)
        ceza_summary = pd.DataFrame(columns=["Order Grup AdÄ±", "Cari AdÄ±", "Row_Ceza"])
        if not df_proc.empty:
             for col in ["Alim_Tutari", "Iade_Tutari", "Siparis_Gecikme"]:
                 if col in df_proc.columns: df_proc[col] = df_proc[col].fillna(0)
             # Order bazÄ±nda gecikme ve cezayÄ± hesapla
             grp_det = df_proc.groupby(["Cari AdÄ±", "Order No", "Order Grup AdÄ±"]).agg({"Siparis_Gecikme": "max", "Alim_Tutari": "sum", "Iade_Tutari": "sum"}).reset_index()
             def calc_penalty(r):
                 s_gec = r["Siparis_Gecikme"]; ceza_orani = 0.0
                 if s_gec > 0:
                     if s_gec < 7: ceza_orani = 0.05
                     elif 7 <= s_gec <= 15: ceza_orani = 0.10
                     else: ceza_orani = 0.25
                 return (r["Alim_Tutari"] - r["Iade_Tutari"]) * ceza_orani
             grp_det["Row_Ceza"] = grp_det.apply(calc_penalty, axis=1)
             ceza_summary = grp_det.groupby(["Order Grup AdÄ±", "Cari AdÄ±"])["Row_Ceza"].sum().reset_index()

        # 2. Ä°ade/Reklamasyon Verisi
        rek_summary = pd.DataFrame(columns=["Order Grup AdÄ±", "Cari AdÄ±", "Reklamasyon_Tutari", "Iade_Tutari", "Kesinti_Gecikme", "Kesinti_Kalite"])
        if not df_rek.empty:
            rek_summary = df_rek.groupby(["Order Grup AdÄ±", "Cari AdÄ±"]).agg({"Reklamasyon_Tutari": "sum", "Iade_Tutari": "sum", "Kesinti_Gecikme": "sum", "Kesinti_Kalite": "sum"}).reset_index()

        # 3. OUTER MERGE (KapsayÄ±cÄ± BirleÅŸtirme)
        # Hem ceza verisini hem de iade/reklamasyon verisini kaybetmemek iÃ§in outer join yapÄ±yoruz.
        if ceza_summary.empty and rek_summary.empty:
             merged_data = pd.DataFrame(columns=["Order Grup AdÄ±", "Cari AdÄ±", "Row_Ceza", "Reklamasyon_Tutari", "Iade_Tutari", "Kesinti_Gecikme", "Kesinti_Kalite"])
        else:
             merged_data = pd.merge(rek_summary, ceza_summary, on=["Order Grup AdÄ±", "Cari AdÄ±"], how="outer").fillna(0)
        
        current_summary1 = merged_data # Export iÃ§in

        f1 = tk.LabelFrame(tab_ozet, text="1. TakÄ±m ve TedarikÃ§i DetaylÄ± Analiz", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=5); f1.pack(fill="both", expand=True, padx=10, pady=5)
        cols1 = ["TakÄ±m", "Cari AdÄ±", "Kesilmesi Gereken (Ceza)", "Reklamasyon TutarÄ± (52)", "Ä°ade TutarÄ± (63)", "Kesilen Reklamasyon - Gecikme", "Kesilen Reklamasyon - Kalite"]
        t1 = ttk.Treeview(f1, columns=cols1, show="headings", height=6)
        sb1 = ttk.Scrollbar(f1, orient="vertical", command=t1.yview); t1.configure(yscrollcommand=sb1.set)
        t1.grid(row=0, column=0, sticky='nsew'); sb1.grid(row=0, column=1, sticky='ns')
        f1.grid_columnconfigure(0, weight=1); f1.grid_rowconfigure(0, weight=1)
        for c in cols1: t1.heading(c, text=c); t1.column(c, anchor="e" if "TutarÄ±" in c or "Kesilen" in c or "Ceza" in c else "w", width=110)

        t1_ceza=0; t1_rek=0; t1_iade=0; t1_gec=0; t1_kal=0
        for i, r in merged_data.iterrows():
            t1.insert("", "end", values=(r["Order Grup AdÄ±"], r["Cari AdÄ±"], f"â‚º{r['Row_Ceza']:,.0f}", f"â‚º{r['Reklamasyon_Tutari']:,.0f}", f"â‚º{r['Iade_Tutari']:,.0f}", f"â‚º{r['Kesinti_Gecikme']:,.0f}", f"â‚º{r['Kesinti_Kalite']:,.0f}"))
            t1_ceza+=r['Row_Ceza']; t1_rek+=r['Reklamasyon_Tutari']; t1_iade+=r['Iade_Tutari']; t1_gec+=r['Kesinti_Gecikme']; t1_kal+=r['Kesinti_Kalite']
        # Tablo 1 Alt Toplam
        t1.insert("", "end", values=("GENEL TOPLAM", "", f"â‚º{t1_ceza:,.0f}", f"â‚º{t1_rek:,.0f}", f"â‚º{t1_iade:,.0f}", f"â‚º{t1_gec:,.0f}", f"â‚º{t1_kal:,.0f}"), tags=('bold',)); t1.tag_configure('bold', font=('Segoe UI', 10, 'bold'), background='#cfd8dc')


        f2 = tk.LabelFrame(tab_ozet, text="2. TakÄ±m Genel Ã–zeti", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=5); f2.pack(fill="both", expand=True, padx=10, pady=5)
        cols2 = ["TakÄ±m", "Gereken Ceza (Hesaplanan)", "Reklamasyon TutarÄ± (52)", "Ä°ade TutarÄ± (63)", "Kesilen Reklamasyon - Gecikme", "Kesilen Reklamasyon - Kalite"]
        t2 = ttk.Treeview(f2, columns=cols2, show="headings", height=6)
        sb2 = ttk.Scrollbar(f2, orient="vertical", command=t2.yview); t2.configure(yscrollcommand=sb2.set)
        t2.grid(row=0, column=0, sticky='nsew'); sb2.grid(row=0, column=1, sticky='ns')
        f2.grid_columnconfigure(0, weight=1); f2.grid_rowconfigure(0, weight=1)
        for c in cols2: t2.heading(c, text=c); t2.column(c, anchor="e" if "TutarÄ±" in c or "Kesilen" in c or "Ceza" in c else "w", width=120)

        if not merged_data.empty:
            grp2 = merged_data.groupby("Order Grup AdÄ±").agg({"Row_Ceza": "sum", "Reklamasyon_Tutari": "sum", "Iade_Tutari": "sum", "Kesinti_Gecikme": "sum", "Kesinti_Kalite": "sum"}).reset_index()
            current_summary2 = grp2
            t_ceza=0; t_rek=0; t_iade=0; t_gec=0; t_kal=0
            for i, r in grp2.iterrows():
                t2.insert("", "end", values=(r["Order Grup AdÄ±"], f"â‚º{r['Row_Ceza']:,.0f}", f"â‚º{r['Reklamasyon_Tutari']:,.0f}", f"â‚º{r['Iade_Tutari']:,.0f}", f"â‚º{r['Kesinti_Gecikme']:,.0f}", f"â‚º{r['Kesinti_Kalite']:,.0f}"))
                t_ceza+=r['Row_Ceza']; t_rek+=r['Reklamasyon_Tutari']; t_iade+=r['Iade_Tutari']; t_gec+=r['Kesinti_Gecikme']; t_kal+=r['Kesinti_Kalite']
            t2.insert("", "end", values=("TOPLAM", f"â‚º{t_ceza:,.0f}", f"â‚º{t_rek:,.0f}", f"â‚º{t_iade:,.0f}", f"â‚º{t_gec:,.0f}", f"â‚º{t_kal:,.0f}"), tags=('bold',)); t2.tag_configure('bold', font=('Segoe UI', 10, 'bold'), background='#cfd8dc')
        auto_generate_ai_comment(tab_ozet, "Ã–zet")

    setup_detail_tab(); setup_summary_tab()

# ---------- DÄ°ÄžER SAYFALAR (SipariÅŸ Ã–zeti, Galeri vb.) ----------
def init_order_summary_tab():
    for w in frame_siparis_ozet.winfo_children(): w.destroy()
    tk.Label(frame_siparis_ozet, text="SipariÅŸ BazlÄ± Konsolide Rapor", font=("Segoe UI", 14, "bold")).pack(pady=10)
    f = tk.Frame(frame_siparis_ozet); f.pack(fill="both", expand=True, padx=20)
    cols = ["Order No", "AlÄ±m TutarÄ±", "Ä°ade TutarÄ±", "Reklamasyon TutarÄ±"]
    tr = ttk.Treeview(f, columns=cols, show="headings"); tr.pack(side="left", fill="both", expand=True)
    sb = ttk.Scrollbar(f, orient="vertical", command=tr.yview); sb.pack(side="right", fill="y"); tr.configure(yscrollcommand=sb.set)
    for c in cols: tr.heading(c, text=c)
    if df_global is not None:
        g = df_global.groupby("Order No")[["Alim_Tutari", "Iade_Tutari", "Reklamasyon_Tutari"]].sum().reset_index()
        for i, r in g.iterrows(): tr.insert("", "end", values=(r["Order No"], f"{r['Alim_Tutari']:,.0f}", f"{r['Iade_Tutari']:,.0f}", f"{r['Reklamasyon_Tutari']:,.0f}"))
    auto_generate_ai_comment(frame_siparis_ozet)

def init_gallery_tab():
    for w in frame_galeri.winfo_children(): w.destroy()
    tk.Label(frame_galeri, text="ðŸ“¸ FotoÄŸraf KanÄ±tlarÄ±", font=("Segoe UI", 16, "bold")).pack(pady=10)
    btn_frame = tk.Frame(frame_galeri); btn_frame.pack(fill="x", padx=20)
    def foto_yukle():
        path = filedialog.askopenfilename(filetypes=[("Resimler", "*.jpg *.png")]); 
        if path: defect_images.append(path); refresh_gallery()
    ttk.Button(btn_frame, text="FotoÄŸraf Ekle", command=foto_yukle).pack(side="left")
    scroll = tk.Frame(frame_galeri); scroll.pack(fill="both", expand=True, pady=10)
    canvas = tk.Canvas(scroll); sb = ttk.Scrollbar(scroll, command=canvas.yview); cont = tk.Frame(canvas)
    cont.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0,0), window=cont, anchor="nw"); canvas.configure(yscrollcommand=sb.set)
    canvas.pack(side="left", fill="both", expand=True); sb.pack(side="right", fill="y")
    def refresh_gallery():
        for w in cont.winfo_children(): w.destroy()
        r, c = 0, 0
        for p in defect_images:
            try:
                img = Image.open(p); img.thumbnail((150, 150)); ph = ImageTk.PhotoImage(img)
                f = tk.Frame(cont, bd=1, relief="solid", padx=5, pady=5); f.grid(row=r, column=c, padx=5, pady=5)
                tk.Label(f, image=ph).pack(); tk.Label(f, text=os.path.basename(p)[:10]).pack(); f.image = ph
                c += 1; 
                if c > 4: c=0; r+=1
            except: pass
    refresh_gallery()

def init_report_tab():
    for w in frame_rapor.winfo_children(): w.destroy()
    tk.Label(frame_rapor, text="ðŸ“„ Rapor ve Ã‡Ä±ktÄ±", font=("Segoe UI", 16, "bold")).pack(pady=10)
    tk.Button(frame_rapor, text="PDF Kaydet", font=("Segoe UI", 12), bg="#2ecc71", fg="white", padx=20, pady=10, command=lambda: messagebox.showinfo("Bilgi", "PDF HazÄ±rlanÄ±yor...")).pack()

# ---------- ANA PENCERE & NAVÄ°GASYON ----------
def show_page(page_name):
    global current_page_name
    current_page_name = page_name
    for frame in frames.values(): frame.pack_forget()
    frames[page_name].pack(fill="both", expand=True)
    if page_name == "Mail Merkezi": init_mail_tab()
    elif page_name == "Dashboard": draw_dashboard(frame_ozet)
    elif page_name == "DetaylÄ± Rapor": init_detailed_report_tab()
    elif page_name == "SipariÅŸ Ã–zeti": init_order_summary_tab()
    elif page_name == "Galeri": init_gallery_tab()
    elif page_name == "Raporlama": init_report_tab()
    for btn_name, btn in menu_buttons.items():
        if btn_name == page_name: btn.config(bg="#34495e", fg="#3498db", relief="sunken")
        else: btn.config(bg="#2c3e50", fg="white", relief="flat")

root = ThemedTk(theme=THEME_NAME)
root.title(APP_TITLE)
root.geometry("1300x850")

sidebar = tk.Frame(root, bg="#2c3e50", width=240); sidebar.pack(side="left", fill="y"); sidebar.pack_propagate(False)
tk.Label(sidebar, text="REKLAMASYON\nYÃ–NETÄ°MÄ°", bg="#2c3e50", fg="white", font=("Segoe UI", 16, "bold"), pady=40).pack()

content_area = tk.Frame(root, bg="white"); content_area.pack(side="right", fill="both", expand=True)

frame_ozet = tk.Frame(content_area, bg="white")
frame_detayli = tk.Frame(content_area, bg="white")
frame_siparis_ozet = tk.Frame(content_area, bg="white")
frame_galeri = tk.Frame(content_area, bg="white")
frame_rapor = tk.Frame(content_area, bg="white")
frame_mail = tk.Frame(content_area, bg="white") # Mail Frame

frames = {
    "Dashboard": frame_ozet,
    "DetaylÄ± Rapor": frame_detayli,
    "SipariÅŸ Ã–zeti": frame_siparis_ozet,
    "Galeri": frame_galeri,
    "Raporlama": frame_rapor,
    "Mail Merkezi": frame_mail
}

menu_items = [
    ("ðŸ“Š YÃ¶netici Ã–zeti", "Dashboard"),
    ("ðŸ“‘ DetaylÄ± Raporlar", "DetaylÄ± Rapor"),
    ("ðŸ“¦ SipariÅŸ Ã–zeti", "SipariÅŸ Ã–zeti"),
    ("ðŸ“¸ FotoÄŸraf Galeri", "Galeri"),
    ("ðŸ“„ Ã‡Ä±ktÄ± & ArÅŸiv", "Raporlama"),
    ("ðŸ“§ Mail Merkezi", "Mail Merkezi")
]

for text, name in menu_items:
    btn = tk.Button(sidebar, text=text, font=("Segoe UI", 11), bg="#2c3e50", fg="white", bd=0, cursor="hand2", pady=12, anchor="w", padx=20,
                    command=lambda n=name: show_page(n))
    btn.pack(fill="x", pady=2)
    menu_buttons[name] = btn

btn_load = tk.Button(sidebar, text="ðŸ“‚ Veri YÃ¼kle (Excel)", bg="#27ae60", fg="white", font=("Segoe UI", 10, "bold"),
                     command=lambda: init_input_tab_logic())
btn_load.pack(side="bottom", fill="x", padx=20, pady=20)

def init_input_tab_logic():
    path = filedialog.askopenfilename(filetypes=[("Excel Files", "*.xlsx")])
    if path:
        success, msg = load_data(path)
        if success:
            messagebox.showinfo("BaÅŸarÄ±lÄ±", msg)
            if current_page_name: show_page(current_page_name)
        else:
            messagebox.showerror("Hata", msg)

load_data()
show_page("Dashboard")
root.mainloop()
